"use strict";var q=Object.defineProperty;var S=(t,e)=>()=>(t&&(e=t(t=0)),e);var c=(t,e)=>{for(var o in e)q(t,o,{get:e[o],enumerable:!0})};var V={};c(V,{default:()=>l});var U,$,T,P,A,O,k,H,L,_,w,l,y=S(()=>{"use strict";U=require("dotenv");(0,U.config)();({DISCORD_TOKEN:$,GUILD_ID:T,CLIENT_ID:P,RENDER_DISCOVERY_SERVICE:A,USER_EMAIL:O,USER_PASSWORD:k,URL:H,SCHEDULE_NUMBER:L,CENTER_NUMBER:_}=process.env);if(!$||!T||!P)throw new Error("Missing environment variables");if(!O||!k||!H||!L||!_)throw new Error("Missing environment variables");w="";A?w=A:w=process.env.COMPUTERNAME??"Unknown Hostname";l={DISCORD_TOKEN:$,GUILD_ID:T,CLIENT_ID:P,HOSTNAME:w,USER_EMAIL:O,USER_PASSWORD:k,URL:H,SCHEDULE_NUMBER:L,CENTER_NUMBER:_}});var F={};c(F,{Settings:()=>a});var a,p=S(()=>{"use strict";a={usvisa:{targetDate:"2024-12-31",isMonitoringActive:!1},cineplex:{isMonitoringActive:!1},icbc:{isMonitoringActive:!1,dates:["2024-12-31"]}}});var b={};c(b,{availableDates2ChannelId:()=>te,availableDatesChannelId:()=>ee,earliestAvailableDateChannelId:()=>oe,errorReportingChannelId:()=>ne,lastStatusChannelId:()=>ie,recordsChannelId:()=>ae});var ee,te,oe,ne,ie,ae,I=S(()=>{"use strict";ee="1214355558413377556",te="1230247492323377265",oe="1214355844947513345",ne="1216112978118836234",ie="1216116149939343410",ae="1236754890143957012"});var r=require("discord.js");y();var h=class{configuration;retryInterval=6e4;defaultHeaders={"x-requested-with":"XMLHttpRequest"};cookieData="";notificationService;constructor(e,o){this.configuration=e,this.notificationService=o}async getTimes(e){let o=`/en-ca/niv/schedule/${this.configuration.scheduleNumber}/appointment/times/${this.configuration.centerNumber}.json?date=${e}&appointments[expedite]=false`;return this.fetchEndpoint(o,!0)}async fetchAvailableDates(){let e=`/en-ca/niv/schedule/${this.configuration.scheduleNumber}/appointment/days/${this.configuration.centerNumber}.json?appointments[expedite]=false`;return await this.fetchEndpoint(e,!0)}async signOut(){await fetch(`${this.configuration.url}/en-ca/niv/users/sign_out`)}async monitorVisaDatesAvailability(){try{let e=await Promise.resolve().then(()=>(y(),V)).then(i=>i.default);if(!(await Promise.resolve().then(()=>(p(),F)).then(i=>i.Settings)).usvisa.isMonitoringActive){this.scheduleNextCheck();return}await this.performLogin();let n=await this.fetchAvailableDates();if(!n||"error"in n||n.length===0){console.log("No available dates found"),this.scheduleNextCheck();return}await this.processAvailableDates(n),this.scheduleNextCheck()}catch(e){console.error("Error in monitoring:",e),await this.handleError(e),this.scheduleNextCheck(5)}}async processAvailableDates(e){let{availableDatesChannelId:o,earliestAvailableDateChannelId:n}=await Promise.resolve().then(()=>(I(),b));if("error"in e){await this.handleError(new Error(e.error));return}let i=[{name:"Status",value:"Visa dates available!"},{name:"Count",value:e.length.toString()}];await this.notificationService.sendMessage(o,i)}async handleError(e){let{errorReportingChannelId:o}=await Promise.resolve().then(()=>(I(),b));await this.notificationService.sendError(o,e)}scheduleNextCheck(e=60){setTimeout(()=>{this.monitorVisaDatesAvailability()},e*60*1e3)}async performLogin(){let e={utf8:"\u2713","user[email]":this.configuration.userEmail,"user[password]":this.configuration.userPassword,policy_confirmed:"1",commit:"Sign In"},o=new URLSearchParams;Object.entries(e).forEach(([d,m])=>{o.append(d,m)});let i=(await fetch(`${this.configuration.url}/en-ca/niv/users/sign_in`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",...this.defaultHeaders},body:o.toString()})).headers.get("set-cookie");i&&(this.cookieData=i)}async fetchEndpoint(e,o=!1){let n={...this.defaultHeaders};o&&this.cookieData&&(n.Cookie=this.cookieData);let i=await fetch(`${this.configuration.url}${e}`,{method:"GET",headers:n});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.json()}};var B=require("discord.js"),g=class{client;constructor(e){this.client=e}async sendMessage(e,o){let n=new Date().toLocaleString("en-US",{timeZone:"America/Los_Angeles"});console.log(`${n}: ${o.map(m=>`${m.name}: ${m.value}`).join(", ")}`);let i=this.createEmbedMessageWithFields(o,n),d=await this.getChannel(e);d&&await d.send({embeds:[i]})}async sendError(e,o){let n=[{name:"Error",value:o.message},{name:"Time",value:new Date().toISOString()}];await this.sendMessage(e,n)}async getChannel(e){try{let o=this.client.channels.cache.get(e);return o||(o=await this.client.channels.fetch(e)),o}catch(o){return console.error(`Failed to get channel ${e}:`,o),null}}createEmbedMessageWithFields(e,o){let n=new B.EmbedBuilder().setColor(39423).setTimestamp().setFooter({text:`PST: ${o}`});return e.forEach(i=>{n.addFields({name:i.name,value:i.value,inline:!0})}),n}};var f=class{service;constructor(e,o){let n=new g(e);this.service=new h(o,n)}async monitorVisaDatesAvailability(){return this.service.monitorVisaDatesAvailability()}async getTimes(e){return this.service.getTimes(e)}async fetchAvailableDates(){return this.service.fetchAvailableDates()}async signOut(){return this.service.signOut()}};var N={};c(N,{help:()=>D,monitor:()=>M,monitorcineplexes:()=>x,ping:()=>E,setdesireddate:()=>R});var x={};c(x,{data:()=>se,execute:()=>le});var W=require("discord.js");p();var se=new W.SlashCommandBuilder().setName("cineplex").setDescription("Start/Stop monitoring for Cineplex booking availability").addSubcommand(t=>t.setName("start").setDescription("Start monitoring for Cineplex booking availability")).addSubcommand(t=>t.setName("stop").setDescription("Stop monitoring for Cineplex booking availability"));async function re(t){if(a.cineplex.isMonitoringActive){await t.reply("Already monitoring");return}a.cineplex.isMonitoringActive=!0,await t.reply("Monitoring started")}async function ce(t){if(!a.cineplex.isMonitoringActive){await t.reply("Not monitoring");return}a.cineplex.isMonitoringActive=!1,await t.reply("Monitoring stopped")}async function le(t){let e=t.options.getSubcommand();e==="start"?await re(t):e==="stop"&&await ce(t)}var D={};c(D,{data:()=>me,execute:()=>de});var Y=require("discord.js"),me=new Y.SlashCommandBuilder().setName("help").setDescription("Create a help message for the bot.	").addSubcommand(t=>t.setName("user").setDescription("Info about a user").addUserOption(e=>e.setName("target").setDescription("The user"))).addSubcommand(t=>t.setName("server").setDescription("Info about the server"));async function de(t){let e;try{e=window.location.hostname}catch{e=""}await t.reply("help server reply from window.location.hostname")}var E={};c(E,{data:()=>pe,execute:()=>ue});var j=require("discord.js"),pe=new j.SlashCommandBuilder().setName("ping").setDescription("Replies with Pong!");async function ue(t){await t.reply("Pong!")}var M={};c(M,{data:()=>he,execute:()=>ve});var K=require("discord.js");p();var he=new K.SlashCommandBuilder().setName("monitor").setDescription("Start/Stop monitoring for US visa appointment availability").addSubcommand(t=>t.setName("start").setDescription("Start monitoring for US visa appointment availability")).addSubcommand(t=>t.setName("stop").setDescription("Stop monitoring for US visa appointment availability"));async function ge(t){if(a.usvisa.isMonitoringActive){await t.reply("Already monitoring");return}a.usvisa.isMonitoringActive=!0,await t.reply("Monitoring started")}async function fe(t){if(!a.usvisa.isMonitoringActive){await t.reply("Not monitoring");return}a.usvisa.isMonitoringActive=!1,await t.reply("Monitoring stopped")}async function ve(t){let e=t.options.getSubcommand();e==="start"?await ge(t):e==="stop"&&await fe(t)}var R={};c(R,{data:()=>Ce,execute:()=>Se});var G=require("discord.js");p();var Ce=new G.SlashCommandBuilder().setName("setdesireddate").setDescription("Set your desired US visa appointment date").addStringOption(t=>t.setName("date").setDescription("Desired date for US visa appointment in the format YYYY-MM-DD (e.g. 2024-12-31)").setRequired(!0));async function Se(t){let e=t.options.getString("date");if(!e||!/^\d{4}-\d{2}-\d{2}$/.test(e)){await t.reply("Invalid date");return}a.usvisa.targetDate=e,await t.reply(`Your desired US visa appointment date has been set to ${a.usvisa.targetDate}`)}var J=Object(N),v=new r.Client({intents:[r.GatewayIntentBits.Guilds,r.GatewayIntentBits.GuildMessages,r.GatewayIntentBits.MessageContent,r.GatewayIntentBits.DirectMessages]});v.once(r.Events.ClientReady,t=>{console.log(`Ready!${t.user?.tag}`);let e={userEmail:l.USER_EMAIL||"",userPassword:l.USER_PASSWORD||"",url:l.URL||"",scheduleNumber:l.SCHEDULE_NUMBER||"",centerNumber:l.CENTER_NUMBER||""};new f(t,e).monitorVisaDatesAvailability()});v.on(r.Events.InteractionCreate,async t=>{if(t.isChatInputCommand()){let{commandName:e}=t;if(J[e])try{await J[e].execute(t,v)}catch(o){console.error(`Error executing command ${e}:`,o)}else console.error(`Command ${e} not found`)}});v.login(l.DISCORD_TOKEN);var C=require("http"),X=require("https"),Z=require("url"),Q=[process.env.API_KEY].filter(Boolean);function u(t,e){return t["access-control-allow-origin"]="*",e.headers["access-control-request-method"]&&(t["access-control-allow-methods"]=e.headers["access-control-request-method"],delete e.headers["access-control-request-method"]),e.headers["access-control-request-headers"]&&(t["access-control-allow-headers"]=e.headers["access-control-request-headers"],delete e.headers["access-control-request-headers"]),t}function we(t){let e=t.headers["x-api-key"];return Q.length>0&&Q.includes(e)}function ye(t,e){let o=t.url?.slice(1);if(!o){console.log(`\u26A0 Invalid request - no target URL: ${t.method} ${t.url} from ${t.socket.remoteAddress}`),e.writeHead(400,{"Content-Type":"text/plain"}),e.end("Invalid URL: URL must be in the format /https://example.com");return}let n;try{if(n=(0,Z.parse)(o),!n.protocol||!n.host)throw new Error("Incomplete URL provided")}catch(s){console.log(`\u26A0 Invalid URL format: ${o} from ${t.socket.remoteAddress} - ${s instanceof Error?s.message:"Unknown error"}`),e.writeHead(400,{"Content-Type":"text/plain"}),e.end(`Invalid URL: ${s instanceof Error?s.message:"Unknown error"}`);return}let i={protocol:n.protocol,hostname:n.hostname,port:n.port,path:n.path||"/",method:t.method,headers:{...t.headers,host:n.hostname||void 0}},m=(n.protocol==="https:"?X.request:C.request)(i,s=>{console.log(`\u2713 ${t.method} ${o} -> ${s.statusCode}`),e.writeHead(s.statusCode||500,u(s.headers||{},t)),s.pipe(e,{end:!0})});m.on("error",s=>{console.log(`\u2717 Proxy error for ${o}: ${s.message}`),e.writeHead(500,u({},t)),e.end(`Proxy error: ${s.message}`)}),t.pipe(m,{end:!0})}var be=(0,C.createServer)((t,e)=>{if(t.url==="/alive"){console.log(`\u{1F493} Health check from ${t.socket.remoteAddress}`),e.writeHead(200,{"Content-Type":"text/plain"}),e.end("Alive Test");return}if(t.method==="OPTIONS"){e.writeHead(200,u({},t)),e.end();return}if(!we(t)){console.log(`\u26A0 Unauthorized access attempt: ${t.method} ${t.url} from ${t.socket.remoteAddress}`),e.writeHead(404,u({"Content-Type":"text/plain"},t)),e.end("Not Found");return}if(t.url==="/"||t.url===""){e.writeHead(200,{"Content-Type":"text/plain",...u({},t)}),e.end("CORS Proxy server is running. Please specify a target URL in the format /https://example.com");return}ye(t,e)}),z=Number(process.env.PORT)||8080;be.listen(z,()=>console.log(`\u{1F680} CORS Proxy server running on port ${z}`));
